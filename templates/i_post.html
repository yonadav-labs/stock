{% extends 'base.html' %} 
{% load humanize %} 
{% load extra %} 

{% block css %}
<style type="text/css">
    .error {
        color: red;
    }

    .error ul {
        list-style-type: none;
        padding-left: 14px;        
    }

    .share-max {
        cursor: pointer;
        color: black;
        font-weight: 600;
    }

    select {
        height: 34px !important;
    }
</style>
{% endblock %}

{% block body %}

<div class="container-fluid">
    <div class="col-lg-12 col-xl-10 offset-xl-1">

        <div class="row mt-3">
            <h3>Issuer - Offer Shares</h3>
        </div>
        <div class="row mt-3 error">
            {{ form.non_field_errors }}
            {{ form.errors }}
        </div>
        <div class="row mt-3">
            <div class="col">
                SYMBOL
            </div>
            <div class="col">
                ACTION
            </div>
            <div class="col">
                SHARES OFFERED&nbsp;&nbsp;
                <span title="{{ ii.num_shares_available }}" class="share-max">( Max )</span>
            </div>
            <div class="col">
                MIN TO BUY
            </div>
            <div class="col">
                DISCOUNT
            </div>
            <div class="col">
                TYPE
            </div>
            <div class="col">
                MA DAYS
            </div>
            <div class="col">
                MIN PRICE
            </div>
            <div class="col">
                DURATION
            </div>
        </div>

        <form method="post">
            <div class="row">
                {% csrf_token %}
                <div class="col">
                    <input type="text" class="form-control input_symbol" name="symbol" value="{% if form.symbol.value %}{{ form.symbol.value }}{% endif %}" readonly="">
                </div>
                <div class="col">
                    SELL
                    <input type="hidden" name="action" value="SELL">
                </div>
                <div class="col">
                    <input type="text" name="shares_max" value='{% if form.shares_max.value %}{{ form.shares_max.value }}{% endif %}' class="form-control" required="">
                </div>
                <div class="col">
                    <input type="text" name="shares_min" value='{% if form.shares_min.value %}{{ form.shares_min.value }}{% endif %}' class="form-control" required="">
                </div>
                <div class="col">
                    <select class="form-control" name="discount">
                        {% for ii in range_discount %}
                        <option value="{{ ii }}" {% if ii == form.discount.value %} selected {% endif %}>{{ ii }}%</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col">
                    <select class="form-control ft-type" name="ft_type">
                        <option value="FTS" {% if form.ft_type.value == 'FTS' %} selected="" {% endif %}>FTS</option>
                        <option value="MA" {% if form.ft_type.value == 'MA' %} selected="" {% endif %}>MA</option>
                    </select>
                </div>
                <div class="col">
                    {% if form.ft_type.value != 'MA' %}
                        <select class="form-control ma_days" name="ma_days" disabled="">
                            <option value="">N/A</option>
                        </select>
                    {% else %}                
                        <select class="form-control ma_days" name="ma_days">
                            {% for ii in range_madays %}
                            <option value="{{ ii }}">{{ ii }} </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                </div>
                <div class="col">
                    <input type="number" step="0.01" class="form-control" name="min_price" value="{{ form.min_price.value }}" min="0" required="">
                </div>
                <div class="col">
                    <select class="form-control" name="duration">
                        <option value="DAY" {% if form.duration.value == 'DAY' %} selected="" {% endif %}>DAY</option>
                        <option value="GTC" {% if form.duration.value == 'GTC' %} selected="" {% endif %}>GTC</option>
                    </select>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-md-3">
                    <input type="submit" value="Submit" class="btn btn-success btn-submit">
                </div>

                <div class="col-md-3">
                    ACCEPT COUNTER BIDS?
                </div>

                <div class="col-md-1">
                    <label class="radio-inline">
                        <input type="radio" name="accept_counter_bids" {% if form.accept_counter_bids.value %} checked="" {% endif %} value="true">YES</label>
                </div>

                <div class="col-md-1">
                    <label class="radio-inline">
                        <input type="radio" name="accept_counter_bids" {% if not form.accept_counter_bids.value %} checked="" {% endif %} value="false">NO</label>
                </div>
            </div>
            <div class="row">
                <div class="offset-md-3 col-md-3">
                    ACCEPT PRIVATE COUNTER OFFER?
                </div>

                <div class="col-md-1">
                    <label class="radio-inline">
                        <input type="radio" name="accept_private_counter_offer" {% if form.accept_private_counter_offer.value %} checked="" {% endif %} value="true">YES</label>
                </div>

                <div class="col-md-1">
                    <label class="radio-inline">
                        <input type="radio" name="accept_private_counter_offer" value="false" {% if not form.accept_private_counter_offer.value %} checked="" {% endif %}>NO</label>
                </div>
            </div>
        </form>

        <div class="row mt-4">
            <h5>FREE TRADING QUOTE</h5>
        </div>
        <div class="row">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>SYMBOL</th>
                            <th>LAST</th>
                            <th>CHANGE</th>
                            <th>BID</th>
                            <th>ASK</th>
                            <th>HIGH</th>
                            <th>LOW</th>
                            <th>VOLUME</th>
                            <th>Max Shares Available</th>                            
                        </tr>
                    </thead>
                    <tbody class="input_body">
                        <tr data-symbol="{{ ii.symbol }}">
                          <td>{{ ii.symbol }}</td>
                          <td>{{ ii.symbol|last_close }}</td>
                          <td>{{ ii|percent_change }}</td>
                          <td>{{ ii.bid }}</td>
                          <td>{{ ii.ask }}</td>
                          <td>{{ ii.high }}</td>
                          <td>{{ ii.low }}</td>
                          <td>{{ ii.volume|intcomma }}</td>
                          <th>{{ ii.num_shares_available }}</th>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row mt-3">
            <h3>List of Offers</h3>
        </div>

        <div class="row mt-3">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>SYMBOL</th>
                            <th>SHARES OFFERED</th>
                            <th>MIN TO BUY</th>
                            <th>DISCOUNT</th>
                            <th>FT TYPE</th>
                            <th>MA DAYS</th>
                            <th>MIN PRICE</th>
                            <th>DURATION</th>
                            <th>COUNTER BIDS</th>
                            <th>PRIVATE OFFER</th>
                            <th>DISCOUNTED PRICE</th>
                            <th>CREATED AT</th>
                            <th> </th>
                        </tr>
                    </thead>
                    <tbody class="output_body">
                        {% include '_output.html' %}
                    </tbody>
                </table>
            </div>
        </div>        
    </div>
</div>

{% endblock %} 

{% block js %}
<script type="text/javascript">
    $('.ft-type').change(function() {
        var ft_type = $(this).val();
        console.log(ft_type);

        if (ft_type == 'MA') {
            $('.ma_days').html('<option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option>');
            $('.ma_days').removeAttr('disabled');
        } else {
            $('.ma_days').html('<option value="">N/A</option>');
            $('.ma_days').attr('disabled', true);
        }        
    });

    $("body").on('click', '.action.delete', function() {
        var r = confirm("Are you sure to delete this offer?");
        if (r == true) {
            var oid = $(this).data('id');
            $.ajax({
                type: 'post',
                url: '/delete_offer',
                data: {
                    id: oid,
                },
                success: function (data) {
                    location.reload();
                }
            });
        }
    });
</script>
{% endblock %}